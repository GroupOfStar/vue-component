!function(a,b,c){"use strict";b[a]=c()}("StrutChart",this,function(){"use strict";var a=function(a){a.parentElement.removeChild(a)},b=function(a){var b,c,d,e,f;for(b=1,c=arguments.length;c>b;b++){d=arguments[b]||{};for(e in d)f=d[e],void 0!==f&&(a[e]=f)}return a},c=function(a){var b=function(a){return"function"==typeof a||"[object Function]"===Object.prototype.toString.call(a)},c=function(a){var b=Number(a);return isNaN(b)?0:0!==b&&isFinite(b)?(b>0?1:-1)*Math.floor(Math.abs(b)):b},d=Math.pow(2,53)-1,e=function(a){var b=c(a);return Math.min(Math.max(b,0),d)},f=function(a){var f,g,h,i,j,k,c=this,d=Object(a);if(null==a)throw new TypeError("Arrayfrom requires an array-like object - not null or undefined");if(f=arguments.length>1?arguments[1]:void 0,"undefined"!=typeof f){if(!b(f))throw new TypeError("Arrayfrom: when provided, the second argument must be a function");arguments.length>2&&(g=arguments[2])}for(h=e(d.length),i=b(c)?Object(new c(h)):new Array(h),j=0;h>j;)k=d[j],i[j]=f?"undefined"==typeof g?f(k,j):f.call(g,k,j):k,j+=1;return i.length=h,i};return f(a)},d=function(c){var d,e,f,g,h,i,j,k,l;this._name="StrutChart",Promise.prototype.finally=function(a){var b=this.constructor;return this.then(function(c){return b.resolve(a()).then(function(){return c})},function(c){return b.resolve(a()).then(function(){throw c})})},d=this,e={nodeTitle:"name",nodeId:"id",toggleSiblingsResp:!1,depth:999,chartClass:"",exportButton:!1,exportFilename:"StrutChart",parentNodeSymbol:"fa-users",draggable:!1,direction:"t2b",pan:!1,zoom:!1},f=b(e,c),g=f.data,h=document.createElement("div"),i=document.querySelector(f.chartContainer),this.options=f,delete this.options.data,this.chart=h,this.chartContainer=i,h.dataset.options=JSON.stringify(f),h.setAttribute("class","strutchart"+(""!==f.chartClass?" "+f.chartClass:"")+("t2b"!==f.direction?" "+f.direction:"")),"object"==typeof g?this.buildHierarchy(h,f.ajaxURL?g:this._attachRel(g,"00"),0):"string"==typeof g&&g.startsWith("#")?this.buildHierarchy(h,this._buildJsonDS(document.querySelector(g).children[0]),0):(j=document.createElement("i"),j.setAttribute("class","fa fa-circle-o-notch fa-spin spinner"),h.appendChild(j),this._getJSON(g).then(function(a){d.buildHierarchy(h,f.ajaxURL?a:d._attachRel(a,"00"),0)}).catch(function(a){console.error("failed to fetch datasource for strutchart",a)}).finally(function(){var b=h.querySelector(".spinner");a(b)})),h.addEventListener("click",this._clickChart.bind(this)),f.exportButton&&!i.querySelector(".oc-export-btn")&&(k=document.createElement("button"),l=document.createElement("a"),k.setAttribute("class","oc-export-btn"+(""!==f.chartClass?" "+f.chartClass:"")),k.innerHTML="Export",k.addEventListener("click",this._clickExportButton.bind(this)),l.setAttribute("class","oc-download-btn"+(""!==f.chartClass?" "+f.chartClass:"")),l.setAttribute("download",f.exportFilename+".png"),i.appendChild(k),i.appendChild(l)),f.pan&&(i.style.overflow="hidden",h.addEventListener("mousedown",this._onPanStart.bind(this)),h.addEventListener("touchstart",this._onPanStart.bind(this)),document.body.addEventListener("mouseup",this._onPanEnd.bind(this)),document.body.addEventListener("touchend",this._onPanEnd.bind(this))),f.zoom&&(i.addEventListener("wheel",this._onWheeling.bind(this)),i.addEventListener("touchstart",this._onTouchStart.bind(this)),document.body.addEventListener("touchmove",this._onTouchMove.bind(this)),document.body.addEventListener("touchend",this._onTouchEnd.bind(this))),i.appendChild(h)};return d.prototype.getName=function(){return this._name},d.prototype._closest=function(a,b){return a&&(b(a)&&a!==this.chart?a:this._closest(a.parentNode,b))},d.prototype._siblings=function(a,b){return c(a.parentNode.children).filter(function(c){return c!==a?b?a.matches(b):!0:!1})},d.prototype._prevAll=function(a,b){for(var c=[],d=a.previousElementSibling;d;)(!b||d.matches(b))&&c.push(d),d=d.previousElementSibling;return c},d.prototype._nextAll=function(a,b){for(var c=[],d=a.nextElementSibling;d;)(!b||d.matches(b))&&c.push(d),d=d.nextElementSibling;return c},d.prototype._isVisible=function(a){return null!==a.offsetParent},d.prototype._addClass=function(a,b){a.forEach(function(a){b.indexOf(" ")>0?b.split(" ").forEach(function(b){return a.classList.add(b)}):a.classList.add(b)})},d.prototype._removeClass=function(a,b){a.forEach(function(a){b.indexOf(" ")>0?b.split(" ").forEach(function(b){return a.classList.remove(b)}):a.classList.remove(b)})},d.prototype._css=function(a,b,c){a.forEach(function(a){a.style[b]=c})},d.prototype._removeAttr=function(a,b){a.forEach(function(a){a.removeAttribute(b)})},d.prototype._one=function(a,b,c,d){var e=function(f){try{c.call(d,f)}finally{a.removeEventListener(b,e)}};a.addEventListener(b,e)},d.prototype._getDescElements=function(a,b){var c=[];return a.forEach(function(a){c.push(a.querySelectorAll(b))}),c},d.prototype._getJSON=function(a){return new Promise(function(b,c){function e(){4===this.readyState&&(200===this.status?b(JSON.parse(this.response)):c(new Error(this.statusText)))}var d=new XMLHttpRequest;d.open("GET",a),d.onreadystatechange=e,d.responseType="json",d.setRequestHeader("Content-Type","application/json"),d.send()})},d.prototype._buildJsonDS=function(a){var b={name:a.firstChild.textContent.trim(),relationship:("LI"===a.parentNode.parentNode.nodeName?"1":"0")+(a.parentNode.children.length>1?1:0)+(a.children.length?1:0)};return a.id&&(b.id=a.id),a.querySelector("ul")&&c(a.querySelector("ul").children).forEach(function(a){b.children||(b.children=[]),b.children.push(this._buildJsonDS(a))}),b},d.prototype._attachRel=function(a,b){var c,d,e;if(a.relationship=b+(a.children&&a.children.length>0?1:0),a.children)for(c=0,d=a.children.length;d>c;c++)e=a.children[c],this._attachRel(e,"1"+(d>1?1:0));return a},d.prototype._repaint=function(a){a&&(a.style.offsetWidth=a.offsetWidth)},d.prototype._isInAction=function(a){return a.querySelector(".edge").className.indexOf("fa-")>-1},d.prototype._getNodeState=function(a,b){var c,e,d={exist:!1,visible:!1};return"parent"===b?(c=this._closest(a,function(a){return a.classList&&a.classList.contains("nodes")}),c&&(d.exist=!0),d.exist&&this._isVisible(c.parentNode.children[0])&&(d.visible=!0)):"children"===b?(c=this._closest(a,function(a){return"TR"===a.nodeName}).nextElementSibling,c&&(d.exist=!0),d.exist&&this._isVisible(c)&&(d.visible=!0)):"siblings"===b&&(c=this._siblings(this._closest(a,function(a){return"TABLE"===a.nodeName}).parentNode),c.length&&(d.exist=!0),e=this,d.exist&&c.some(function(a){return e._isVisible(a)})&&(d.visible=!0)),d},d.prototype.getRelatedNodes=function(a,b){return"parent"===b?this._closest(a,function(a){return a.classList.contains("nodes")}).parentNode.children[0].querySelector(".node"):"children"===b?c(this._closest(a,function(a){return"TABLE"===a.nodeName}).lastChild.children).map(function(a){return a.querySelector(".node")}):"siblings"===b?this._siblings(this._closest(a,function(a){return"TABLE"===a.nodeName}).parentNode).map(function(a){return a.querySelector(".node")}):[]},d.prototype._switchHorizontalArrow=function(a){var f,g,h,i,b=this.options,c=a.querySelector(".leftEdge"),d=a.querySelector(".rightEdge"),e=this._closest(a,function(a){return"TABLE"===a.nodeName}).parentNode;b.toggleSiblingsResp&&("undefined"==typeof b.ajaxURL||this._closest(a,function(a){return a.classList.contains(".nodes")}).dataset.siblingsLoaded)?(f=e.previousElementSibling,g=e.nextElementSibling,f&&(f.classList.contains("hidden")?(c.classList.add("fa-chevron-left"),c.classList.remove("fa-chevron-right")):(c.classList.add("fa-chevron-right"),c.classList.remove("fa-chevron-left"))),g&&(g.classList.contains("hidden")?(d.classList.add("fa-chevron-right"),d.classList.remove("fa-chevron-left")):(d.classList.add("fa-chevron-left"),d.classList.remove("fa-chevron-right")))):(h=this._siblings(e),i=h.length?!h.some(function(a){return a.classList.contains("hidden")}):!1,c.classList.toggle("fa-chevron-right",i),c.classList.toggle("fa-chevron-left",!i),d.classList.toggle("fa-chevron-left",i),d.classList.toggle("fa-chevron-right",!i))},d.prototype._hoverNode=function(a){var b=a.target,d=!1,e=b.querySelector(".topEdge"),f=b.querySelector(".bottomEdge"),g=b.querySelector(".leftEdge");"mouseenter"===a.type?(e&&(d=this._getNodeState(b,"parent").visible,e.classList.toggle("fa-chevron-up",!d),e.classList.toggle("fa-chevron-down",d)),f&&(d=this._getNodeState(b,"children").visible,f.classList.toggle("fa-chevron-down",!d),f.classList.toggle("fa-chevron-up",d)),g&&this._switchHorizontalArrow(b)):c(b.querySelectorAll(".edge")).forEach(function(a){a.classList.remove("fa-chevron-up","fa-chevron-down","fa-chevron-right","fa-chevron-left")})},d.prototype._clickNode=function(a){var b=a.currentTarget,c=this.chart.querySelector(".focused");c&&c.classList.remove("focused"),b.classList.add("focused")},d.prototype._buildParentNode=function(a,b,c){var d=this,e=document.createElement("table");b.relationship=b.relationship||"001",this._createNode(b,0).then(function(a){var f,g,h,i,b=d.chart;a.classList.remove("slide-up"),a.classList.add("slide-down"),f=document.createElement("tr"),g=document.createElement("tr"),h=document.createElement("tr"),i=document.createElement("tr"),f.setAttribute("class","hidden"),f.innerHTML='<td colspan="2"></td>',e.appendChild(f),g.setAttribute("class","lines hidden"),g.innerHTML='<td colspan="2"><div class="downLine"></div></td>',e.appendChild(g),h.setAttribute("class","lines hidden"),h.innerHTML='<td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td>',e.appendChild(h),i.setAttribute("class","nodes"),i.innerHTML='<td colspan="2"></td>',e.appendChild(i),e.querySelector("td").appendChild(a),b.insertBefore(e,b.children[0]),e.children[3].children[0].appendChild(b.lastChild),c()}).catch(function(a){console.error("Failed to create parent node",a)})},d.prototype._switchVerticalArrow=function(a){a.classList.toggle("fa-chevron-up"),a.classList.toggle("fa-chevron-down")},d.prototype.showParent=function(a){var c,b=this._prevAll(this._closest(a,function(a){return a.classList.contains("nodes")}));this._removeClass(b,"hidden"),this._addClass(Array(b[0].children).slice(1,-1),"hidden"),c=b[2].querySelector(".node"),this._one(c,"transitionend",function(){c.classList.remove("slide"),this._isInAction(a)&&this._switchVerticalArrow(a.querySelector(".topEdge"))},this),this._repaint(c),c.classList.add("slide"),c.classList.remove("slide-down")},d.prototype.showSiblings=function(a,b){var f,g,h,d=[],e=this._closest(a,function(a){return"TABLE"===a.nodeName}).parentNode;d=b?"left"===b?this._prevAll(e):this._nextAll(e):this._siblings(e),this._removeClass(d,"hidden"),f=this._prevAll(this._closest(a,function(a){return a.classList.contains("nodes")})),e=c(f[0].querySelectorAll(".hidden")),b?this._removeClass(e.slice(0,2*d.length),"hidden"):this._removeClass(e,"hidden"),this._getNodeState(a,"parent").visible||(this._removeClass(f,"hidden"),g=f[2].querySelector(".node"),this._one(g,"transitionend",function(a){a.target.classList.remove("slide")},this),this._repaint(g),g.classList.add("slide"),g.classList.remove("slide-down")),h=this,d.forEach(function(a){c(a.querySelectorAll(".node")).forEach(function(a){h._isVisible(a)&&(a.classList.add("slide"),a.classList.remove("slide-left","slide-right"))})}),this._one(d[0].querySelector(".slide"),"transitionend",function(){d.forEach(function(a){h._removeClass(c(a.querySelectorAll(".slide")),"slide")}),this._isInAction(a)&&(this._switchHorizontalArrow(a),a.querySelector(".topEdge").classList.remove("fa-chevron-up"),a.querySelector(".topEdge").classList.add("fa-chevron-down"))},this)},d.prototype.hideSiblings=function(a,b){var g,h,i,j,k,d=this._closest(a,function(a){return"TABLE"===a.nodeName}).parentNode,e=this._siblings(d),f=this;e.forEach(function(a){a.querySelector(".spinner")&&(f.chart.dataset.inAjax=!1)}),(!b||b&&"left"===b)&&(g=this._prevAll(d),g.forEach(function(a){c(a.querySelectorAll(".node")).forEach(function(a){f._isVisible(a)&&a.classList.add("slide","slide-right")})})),(!b||b&&"left"!==b)&&(h=this._nextAll(d),h.forEach(function(a){c(a.querySelectorAll(".node")).forEach(function(a){f._isVisible(a)&&a.classList.add("slide","slide-left")})})),i=[],this._siblings(d).forEach(function(a){Array.prototype.push.apply(i,c(a.querySelectorAll(".slide")))}),j=[];for(a in i)k=this._closest(a,function(a){return a.classList.contains("nodes")}).previousElementSibling,j.push(k),j.push(k.previousElementSibling);j=j.concat(new Set(j)),j.forEach(function(a){a.style.visibility="hidden"}),this._one(i[0],"transitionend",function(){var g,h,k;j.forEach(function(a){a.removeAttribute("style")}),g=[],g=b?"left"===b?f._prevAll(d,":not(.hidden)"):f._nextAll(d,":not(.hidden)"):f._siblings(d),h=c(f._closest(d,function(a){return a.classList.contains("nodes")}).previousElementSibling.querySelectorAll(":not(.hidden)")),k=h.slice(1,b?2*g.length+1:-1),f._addClass(k,"hidden"),f._removeClass(i,"slide"),g.forEach(function(a){c(a.querySelectorAll(".node")).slice(1).forEach(function(a){f._isVisible(a)&&(a.classList.remove("slide-left","slide-right"),a.classList.add("slide-up"))})}),g.forEach(function(a){f._addClass(c(a.querySelectorAll(".lines")),"hidden"),f._addClass(c(a.querySelectorAll(".nodes")),"hidden"),f._addClass(c(a.querySelectorAll(".verticalNodes")),"hidden")}),f._addClass(g,"hidden"),f._isInAction(a)&&f._switchHorizontalArrow(a)},this)},d.prototype.hideParent=function(a){var d,e,f,b=c(this._closest(a,function(a){return a.classList.contains("nodes")}).parentNode.children).slice(0,3);b[0].querySelector(".spinner")&&(this.chart.dataset.inAjax=!1),this._getNodeState(a,"siblings").visible&&this.hideSiblings(a),d=b.slice(1),this._css(d,"visibility","hidden"),e=b[0].querySelector(".node"),f=this._getNodeState(e,"parent").visible,e&&this._isVisible(e)&&(e.classList.add("slide","slide-down"),this._one(e,"transitionend",function(){e.classList.remove("slide"),this._removeAttr(d,"style"),this._addClass(b,"hidden")},this)),e&&f&&this.hideParent(e)},d.prototype.addParent=function(a,b){var c=this;this._buildParentNode(a,b,function(){if(!a.querySelector(".topEdge")){var b=document.createElement("i");b.setAttribute("class","edge verticalEdge topEdge fa"),a.appendChild(b)}c.showParent(a)})},d.prototype._startLoading=function(a,b){var f,g,d=this.options,e=this.chart;return"undefined"!=typeof e.dataset.inAjax&&"true"===e.dataset.inAjax?!1:(a.classList.add("hidden"),f=document.createElement("i"),f.setAttribute("class","fa fa-circle-o-notch fa-spin spinner"),b.appendChild(f),this._addClass(c(b.querySelectorAll("*:not(.spinner)")),"hazy"),e.dataset.inAjax=!0,g=this.chartContainer.querySelector(".oc-export-btn"+(""!==d.chartClass?"."+d.chartClass:"")),g&&(g.disabled=!0),!0)},d.prototype._endLoading=function(b,d){var f,e=this.options;b.classList.remove("hidden"),a(d.querySelector(".spinner")),this._removeClass(c(d.querySelectorAll(".hazy")),"hazy"),this.chart.dataset.inAjax=!1,f=this.chartContainer.querySelector(".oc-export-btn"+(""!==e.chartClass?"."+e.chartClass:"")),f&&(f.disabled=!1)},d.prototype._clickTopEdge=function(a){var b,c,d,e,f,g,h,i;if(a.stopPropagation(),b=this,c=a.target,d=c.parentNode,e=this._getNodeState(d,"parent"),f=this.options,e.exist){if(g=this._closest(d,function(a){return a.classList.contains("nodes")}),h=g.parentNode.firstChild.querySelector(".node"),h.classList.contains("slide"))return;e.visible?(this.hideParent(d),this._one(h,"transitionend",function(){this._isInAction(d)&&(this._switchVerticalArrow(c),this._switchHorizontalArrow(d))},this)):this.showParent(d)}else i=c.parentNode.id,this._startLoading(c,d)&&this._getJSON("function"==typeof f.ajaxURL.parent?f.ajaxURL.parent(d.dataset.source):f.ajaxURL.parent+i).then(function(a){"true"===b.chart.dataset.inAjax&&Object.keys(a).length&&b.addParent(d,a)}).catch(function(a){console.error("Failed to get parent node data.",a)}).finally(function(){b._endLoading(c,d)})},d.prototype.hideChildren=function(a){var g,h,b=this,d=this._nextAll(a.parentNode.parentNode),e=d[d.length-1],f=[];e.querySelector(".spinner")&&(this.chart.dataset.inAjax=!1),g=c(e.querySelectorAll(".node")).filter(function(a){return b._isVisible(a)}),h=e.classList.contains("verticalNodes"),h||(g.forEach(function(a){Array.prototype.push.apply(f,b._prevAll(b._closest(a,function(a){return a.classList.contains("nodes")}),".lines"))}),f=f.concat(new Set(f)),this._css(f,"visibility","hidden")),this._one(g[0],"transitionend",function(){this._removeClass(g,"slide"),h?b._addClass(d,"hidden"):(f.forEach(function(a){a.removeAttribute("style"),a.classList.add("hidden"),a.parentNode.lastChild.classList.add("hidden")}),this._addClass(c(e.querySelectorAll(".verticalNodes")),"hidden")),this._isInAction(a)&&this._switchVerticalArrow(a.querySelector(".bottomEdge"))},this),this._addClass(g,"slide slide-up")},d.prototype.showChildren=function(a){var b=this,d=this._nextAll(a.parentNode.parentNode),e=[];this._removeClass(d,"hidden"),d.some(function(a){return a.classList.contains("verticalNodes")})?d.forEach(function(a){Array.prototype.push.apply(e,c(a.querySelectorAll(".node")).filter(function(a){return b._isVisible(a)}))}):c(d[2].children).forEach(function(a){Array.prototype.push.apply(e,c(a.querySelector("tr").querySelectorAll(".node")).filter(function(a){return b._isVisible(a)}))}),this._repaint(e[0]),this._one(e[0],"transitionend",function(){b._removeClass(e,"slide"),b._isInAction(a)&&b._switchVerticalArrow(a.querySelector(".bottomEdge"))},this),this._addClass(e,"slide"),this._removeClass(e,"slide-up")},d.prototype._buildChildNode=function(a,b,c){var d=b.children||b.siblings;a.querySelector("td").setAttribute("colSpan",2*d.length),this.buildHierarchy(a,{children:d},0,c)},d.prototype.addChildren=function(a,b){var c=this,d=this.options,e=0;this.chart.dataset.inEdit="addChildren",this._buildChildNode.call(this,this._closest(a,function(a){return"TABLE"===a.nodeName}),b,function(){var f,g;++e===b.children.length&&(a.querySelector(".bottomEdge")||(f=document.createElement("i"),f.setAttribute("class","edge verticalEdge bottomEdge fa"),a.appendChild(f)),a.querySelector(".symbol")||(g=document.createElement("i"),g.setAttribute("class","fa "+d.parentNodeSymbol+" symbol"),a.querySelector(".title").appendChild(g)),c.showChildren(a),c.chart.dataset.inEdit="")})},d.prototype._clickBottomEdge=function(a){var b,d,e,f,g,h,i;if(a.stopPropagation(),b=this,d=this.options,e=a.target,f=e.parentNode,g=this._getNodeState(f,"children"),g.exist){if(h=this._closest(f,function(a){return"TR"===a.nodeName}).parentNode.lastChild,c(h.querySelectorAll(".node")).some(function(a){return this._isVisible(a)&&a.classList.contains("slide")}))return;g.visible?this.hideChildren(f):this.showChildren(f)}else i=e.parentNode.id,this._startLoading(e,f)&&this._getJSON("function"==typeof d.ajaxURL.children?d.ajaxURL.children(f.dataset.source):d.ajaxURL.children+i).then(function(a){"true"===b.chart.dataset.inAjax&&a.children.length&&b.addChildren(f,a)}).catch(function(a){console.error("Failed to get children nodes data",a)}).finally(function(){b._endLoading(e,f)})},d.prototype._complementLine=function(a,b,c){var e,f,g,d=a.parentNode.parentNode.children;for(d[0].children[0].setAttribute("colspan",2*b),d[1].children[0].setAttribute("colspan",2*b),e=0;c>e;e++)f=document.createElement("td"),g=document.createElement("td"),f.setAttribute("class","rightLine topLine"),f.innerHTML="&nbsp;",d[2].insertBefore(f,d[2].children[1]),g.setAttribute("class","leftLine topLine"),g.innerHTML="&nbsp;",d[2].insertBefore(g,d[2].children[1])},d.prototype._buildSiblingNode=function(b,d,e){var k,l,m,f=this,g=d.siblings?d.siblings.length:d.children.length,h="TD"===b.parentNode.nodeName?this._closest(b,function(a){return"TR"===a.nodeName}).children.length:1,i=h+g,j=i>1?Math.floor(i/2-1):0;"TD"===b.parentNode.nodeName?(k=this._prevAll(b.parentNode.parentNode),a(k[0]),a(k[1]),l=0,f._buildChildNode.call(f,f._closest(b.parentNode,function(a){return"TABLE"===a.nodeName}),d,function(){var d,k;++l===g&&(d=c(f._closest(b.parentNode,function(a){return"TABLE"===a.nodeName}).lastChild.children),h>1?(k=b.parentNode.parentNode,c(k.children).forEach(function(a){d[0].parentNode.insertBefore(a,d[0])}),a(k),f._complementLine(d[0],i,h),f._addClass(d,"hidden"),d.forEach(function(a){f._addClass(a.querySelectorAll(".node"),"slide-left")})):(k=b.parentNode.parentNode,d[j].parentNode.insertBefore(b.parentNode,d[j+1]),a(k),f._complementLine(d[j],i,1),f._addClass(d,"hidden"),f._addClass(f._getDescElements(d.slice(0,j+1),".node"),"slide-right"),f._addClass(f._getDescElements(d.slice(j+1),".node"),"slide-left")),e())})):(m=0,f.buildHierarchy.call(f,f.chart,d,0,function(){var a,d,g,h;++m===i&&(a=b.nextElementSibling.children[3].children[j],d=document.createElement("td"),d.setAttribute("colspan",2),d.appendChild(b),a.parentNode.insertBefore(d,a.nextElementSibling),f._complementLine(a,i,1),g=f._closest(b,function(a){return a.classList&&a.classList.contains("nodes")}).parentNode.children[0],g.classList.add("hidden"),f._addClass(c(g.querySelectorAll(".node")),"slide-down"),h=this._siblings(b.parentNode),f._addClass(h,"hidden"),f._addClass(f._getDescElements(h.slice(0,j),".node"),"slide-right"),f._addClass(f._getDescElements(h.slice(j),".node"),"slide-left"),e())}))},d.prototype.addSiblings=function(a,b){var c=this;this.chart.dataset.inEdit="addSiblings",this._buildSiblingNode.call(this,this._closest(a,function(a){return"TABLE"===a.nodeName}),b,function(){if(c._closest(a,function(a){return a.classList&&a.classList.contains("nodes")}).dataset.siblingsLoaded=!0,!a.querySelector(".leftEdge")){var b=document.createElement("i"),d=document.createElement("i");b.setAttribute("class","edge horizontalEdge rightEdge fa"),a.appendChild(b),d.setAttribute("class","edge horizontalEdge leftEdge fa"),a.appendChild(d)}c.showSiblings(a),c.chart.dataset.inEdit=""})},d.prototype.removeNodes=function(b){var d=this._closest(b,function(a){return"TABLE"===a.nodeName}).parentNode,e=this._siblings(d.parentNode);"TD"===d.nodeName?this._getNodeState(b,"siblings").exist?(a(e[2].querySelector(".topLine").nextElementSibling),a(e[2].querySelector(".topLine")),e[0].children[0].setAttribute("colspan",e[2].children.length),e[1].children[0].setAttribute("colspan",e[2].children.length),a(d)):(e[0].children[0].removeAttribute("colspan"),a(e[0].querySelector(".bottomEdge")),this._siblings(e[0]).forEach(function(b){a(b)})):c(d.parentNode.children).forEach(function(b){a(b)})},d.prototype._clickHorizontalEdge=function(a){var b,c,d,e,f,g,h,i,j,k,l;if(a.stopPropagation(),b=this,c=this.options,d=a.target,e=d.parentNode,f=this._getNodeState(e,"siblings"),f.exist){if(g=this._closest(e,function(a){return"TABLE"===a.nodeName}).parentNode,h=this._siblings(g),h.some(function(a){var c=a.querySelector(".node");return b._isVisible(c)&&c.classList.contains("slide")}))return;c.toggleSiblingsResp?(i=this._closest(e,function(a){return"TABLE"===a.nodeName}).parentNode.previousElementSibling,j=this._closest(e,function(a){return"TABLE"===a.nodeName}).parentNode.nextElementSibling,d.classList.contains("leftEdge")?i.classList.contains("hidden")?this.showSiblings(e,"left"):this.hideSiblings(e,"left"):j.classList.contains("hidden")?this.showSiblings(e,"right"):this.hideSiblings(e,"right")):f.visible?this.hideSiblings(e):this.showSiblings(e)}else k=d.parentNode.id,l=this._getNodeState(e,"parent").exist?"function"==typeof c.ajaxURL.siblings?c.ajaxURL.siblings(JSON.parse(e.dataset.source)):c.ajaxURL.siblings+k:"function"==typeof c.ajaxURL.families?c.ajaxURL.families(JSON.parse(e.dataset.source)):c.ajaxURL.families+k,this._startLoading(d,e)&&this._getJSON(l).then(function(a){"true"===b.chart.dataset.inAjax&&(a.siblings||a.children)&&b.addSiblings(e,a)}).catch(function(a){console.error("Failed to get sibling nodes data",a)}).finally(function(){b._endLoading(d,e)})},d.prototype._clickToggleButton=function(a){var b=this,d=a.target,e=d.parentNode.nextElementSibling,f=c(e.querySelectorAll(".node")),g=c(e.children).map(function(a){return a.querySelector(".node")});g.some(function(a){return a.classList.contains("slide")})||(d.classList.toggle("fa-plus-square"),d.classList.toggle("fa-minus-square"),f[0].classList.contains("slide-up")?(e.classList.remove("hidden"),this._repaint(g[0]),this._addClass(g,"slide"),this._removeClass(g,"slide-up"),this._one(g[0],"transitionend",function(){b._removeClass(g,"slide")})):(this._addClass(f,"slide slide-up"),this._one(f[0],"transitionend",function(){b._removeClass(f,"slide"),f.forEach(function(a){var c=b._closest(a,function(a){return"UL"===a.nodeName});c.classList.add("hidden")})}),f.forEach(function(a){var d=c(a.querySelectorAll(".toggleBtn"));b._removeClass(d,"fa-minus-square"),b._addClass(d,"fa-plus-square")})))},d.prototype._dispatchClickEvent=function(a){var b=a.target.classList;b.contains("topEdge")?this._clickTopEdge(a):b.contains("rightEdge")||b.contains("leftEdge")?this._clickHorizontalEdge(a):b.contains("bottomEdge")?this._clickBottomEdge(a):b.contains("toggleBtn")?this._clickToggleButton(a):this._clickNode(a)},d.prototype._onDragStart=function(a){var f,g,h,i,j,k,l,m,n,o,b=a.target,d=this.options,e=/firefox/.test(window.navigator.userAgent.toLowerCase());e&&a.dataTransfer.setData("text/html","hack for firefox"),this.chart.style.transform&&(document.querySelector(".ghost-node")?(f=this.chart.querySelector(".ghost-node"),g=f.children[0]):(f=document.createElementNS("http://www.w3.org/2000/svg","svg"),f.classList.add("ghost-node"),g=document.createElementNS("http://www.w3.org/2000/svg","rect"),f.appendChild(g),this.chart.appendChild(f)),h=this.chart.style.transform.split(","),i=Math.abs(window.parseFloat("t2b"===d.direction||"b2t"===d.direction?h[0].slice(h[0].indexOf("(")+1):h[1])),f.setAttribute("width",b.offsetWidth),f.setAttribute("height",b.offsetHeight),g.setAttribute("x",5*i),g.setAttribute("y",5*i),g.setAttribute("width",120*i),g.setAttribute("height",40*i),g.setAttribute("rx",4*i),g.setAttribute("ry",4*i),g.setAttribute("stroke-width",1*i),j=a.offsetX*i,k=a.offsetY*i,"l2r"===d.direction?(j=a.offsetY*i,k=a.offsetX*i):"r2l"===d.direction?(j=b.offsetWidth-a.offsetY*i,k=a.offsetX*i):"b2t"===d.direction&&(j=b.offsetWidth-a.offsetX*i,k=b.offsetHeight-a.offsetY*i),e?(l=document.createElement("img"),l.src="data:image/svg+xml;utf8,"+(new XMLSerializer).serializeToString(f),a.dataTransfer.setDragImage(l,j,k),g.setAttribute("fill","rgb(255, 255, 255)"),g.setAttribute("stroke","rgb(191, 0, 0)")):a.dataTransfer.setDragImage(f,j,k)),m=a.target,n=this._closest(m,function(a){return a.classList&&a.classList.contains("nodes")}),n&&n.parentNode&&(n=n.parentNode.children[0].querySelector(".node")),o=c(this._closest(m,function(a){return"TABLE"===a.nodeName}).querySelectorAll(".node")),this.dragged=m,c(this.chart.querySelectorAll(".node")).forEach(function(a){-1===o.indexOf(a)&&(d.dropCriteria?d.dropCriteria(m,n,a)&&a.classList.add("allowedDrop"):a.classList.add("allowedDrop"))})},d.prototype._onDragOver=function(a){var b=a.currentTarget;b.classList.contains("allowedDrop")&&a.preventDefault()},d.prototype._onDragEnd=function(){c(this.chart.querySelectorAll(".allowedDrop")).forEach(function(a){a.classList.remove("allowedDrop")})},d.prototype._onDrop=function(b){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,d=b.currentTarget,e=this.chart,f=this.dragged,g=this._closest(f,function(a){return a.classList&&a.classList.contains("nodes")}).parentNode.children[0].children[0];this._removeClass(c(e.querySelectorAll(".allowedDrop")),"allowedDrop"),d.parentNode.parentNode.nextElementSibling?(n=window.parseInt(d.parentNode.colSpan)+2,d.parentNode.setAttribute("colspan",n),d.parentNode.parentNode.nextElementSibling.children[0].setAttribute("colspan",n),f.querySelector(".horizontalEdge")||(o=document.createElement("i"),p=document.createElement("i"),o.setAttribute("class","edge horizontalEdge rightEdge fa"),f.appendChild(o),p.setAttribute("class","edge horizontalEdge leftEdge fa"),f.appendChild(p)),q=d.parentNode.parentNode.nextElementSibling.nextElementSibling,r=document.createElement("td"),s=document.createElement("td"),r.setAttribute("class","leftLine topLine"),r.innerHTML="&nbsp;",q.insertBefore(r,q.children[1]),s.setAttribute("class","rightLine topLine"),s.innerHTML="&nbsp;",q.insertBefore(s,q.children[2]),q.nextElementSibling.appendChild(this._closest(f,function(a){return"TABLE"===a.nodeName}).parentNode),t=this._siblings(this._closest(f,function(a){return"TABLE"===a.nodeName}).parentNode).map(function(a){return a.querySelector(".node")}),1===t.length&&(o=document.createElement("i"),p=document.createElement("i"),o.setAttribute("class","edge horizontalEdge rightEdge fa"),t[0].appendChild(o),p.setAttribute("class","edge horizontalEdge leftEdge fa"),t[0].appendChild(p))):(h=document.createElement("i"),h.setAttribute("class","edge verticalEdge bottomEdge fa"),d.appendChild(h),d.parentNode.setAttribute("colspan",2),i=this._closest(d,function(a){return"TABLE"===a.nodeName}),j=document.createElement("tr"),k=document.createElement("tr"),l=document.createElement("tr"),j.setAttribute("class","lines"),j.innerHTML='<td colspan="2"><div class="downLine"></div></td>',i.appendChild(j),k.setAttribute("class","lines"),k.innerHTML='<td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td>',i.appendChild(k),l.setAttribute("class","nodes"),i.appendChild(l),c(f.querySelectorAll(".horizontalEdge")).forEach(function(a){f.removeChild(a)}),m=this._closest(f,function(a){return"TABLE"===a.nodeName}).parentNode,l.appendChild(m)),u=window.parseInt(g.colSpan),u>2?(g.setAttribute("colspan",u-2),g.parentNode.nextElementSibling.children[0].setAttribute("colspan",u-2),q=g.parentNode.nextElementSibling.nextElementSibling,a(q.children[1]),a(q.children[1]),v=c(g.parentNode.parentNode.children[3].children).map(function(a){return a.querySelector(".node")}),1===v.length&&(a(v[0].querySelector(".leftEdge")),a(v[0].querySelector(".rightEdge")))):(g.removeAttribute("colspan"),g.querySelector(".node").removeChild(g.querySelector(".bottomEdge")),c(g.parentNode.parentNode.children).slice(1).forEach(function(b){a(b)})),window.ActiveXObject||"ActiveXObject"in window?(w=document.createEvent("HTMLEvents"),w.initEvent("nodedropped.strutchart",{detail:{draggedNode:f,dragZone:g.children[0],dropZone:d}},void 0),e.dispatchEvent(w)):(w=new CustomEvent("nodedropped.strutchart",{detail:{draggedNode:f,dragZone:g.children[0],dropZone:d}}),e.dispatchEvent(w))},d.prototype._createNode=function(a,b){var c=this,d=this.options;return new Promise(function(e){var g,h,i,j,l,k,m,n,o,p,q,r,s,t,u,v;if(a.children)for(g=0,h=a.children.length;h>g;g++)i=a.children[g],i.parentId=a.id;j=document.createElement("div"),delete a.children,j.dataset.source=JSON.stringify(a),a[d.nodeId]&&(j.id=a[d.nodeId]),k=c.chart.dataset.inEdit,l=k?"addChildren"===k?" slide-up":"":b>=d.depth?" slide-up":"",j.setAttribute("class","node "+(a.className||"")+l),d.draggable&&j.setAttribute("draggable",!0),a.parentId&&j.setAttribute("data-parent",a.parentId),m='<div class="title">'+a[d.nodeTitle]+"</div>",d.nodeContent&&(m=m+'<div class="content">'+a[d.nodeContent]+"</div>"),j.innerHTML=m,n=a.relationship||"","object"==typeof a.relationship&&(n=a.relationship.children_num.toString()+a.relationship.parent_num.toString()+a.relationship.sibling_num.toString()),d.verticalDepth&&b+2>d.verticalDepth?b+1>=d.verticalDepth&&Number(n.substr(2,1))&&(o=document.createElement("i"),p=b+1>=d.depth?"plus":"minus",o.setAttribute("class","toggleBtn fa fa-"+p+"-square"),j.appendChild(o)):(Number(n.substr(0,1))&&(q=document.createElement("i"),q.setAttribute("class","edge verticalEdge topEdge fa"),j.appendChild(q)),Number(n.substr(1,1))&&(r=document.createElement("i"),s=document.createElement("i"),r.setAttribute("class","edge horizontalEdge rightEdge fa"),j.appendChild(r),s.setAttribute("class","edge horizontalEdge leftEdge fa"),j.appendChild(s)),Number(n.substr(2,1))&&(t=document.createElement("i"),u=document.createElement("i"),v=j.querySelector(".title"),t.setAttribute("class","edge verticalEdge bottomEdge fa"),j.appendChild(t),u.setAttribute("class","fa "+d.parentNodeSymbol+" symbol"),v.insertBefore(u,v.children[0]))),j.addEventListener("mouseenter",c._hoverNode.bind(c)),j.addEventListener("mouseleave",c._hoverNode.bind(c)),j.addEventListener("click",c._dispatchClickEvent.bind(c)),d.draggable&&(j.addEventListener("dragstart",c._onDragStart.bind(c)),j.addEventListener("dragover",c._onDragOver.bind(c)),j.addEventListener("dragend",c._onDragEnd.bind(c)),j.addEventListener("drop",c._onDrop.bind(c))),d.createNode&&d.createNode(j,a),e(j)})},d.prototype.buildHierarchy=function(a,b,c,d){var g,j,k,l,m,n,o,p,e=this,f=this.options,h=b.children,i=f.verticalDepth&&c+1>=f.verticalDepth;Object.keys(b).length>1&&(g=i?a:document.createElement("table"),i||a.appendChild(g),this._createNode(b,c).then(function(a){var b,c;i?g.insertBefore(a,g.firstChild):(b=document.createElement("tr"),c="<td ",h?c=c+"colspan="+2*h.length+"></td>":c+="></td>",b.innerHTML=c,b.children[0].appendChild(a),g.insertBefore(b,g.children[0]?g.children[0]:null)),d&&d()}).catch(function(c){console.log(a),console.log(b),console.error("Failed to creat node",c)})),h&&(1===Object.keys(b).length&&(g=a),k=f.verticalDepth&&c+2>=f.verticalDepth,l=e.chart.dataset.inEdit,j=l?"addSiblings"===l?"":" hidden":c+1>=f.depth?" hidden":"",k||(m=document.createElement("tr"),m.setAttribute("class","lines"+j),m.innerHTML='<td colspan="'+2*h.length+'"><div class="downLine"></div></td>',g.appendChild(m)),n=document.createElement("tr"),n.setAttribute("class","lines"+j),o=h.slice(1).map(function(){return'<td class="leftLine topLine">&nbsp;</td><td class="rightLine topLine">&nbsp;</td>'}).join(""),n.innerHTML='<td class="rightLine">&nbsp;</td> '+o+'<td class="leftLine">&nbsp;</td>',k?(p=document.createElement("ul"),j&&p.classList.add(j.trim()),c+2===f.verticalDepth?(m=document.createElement("tr"),m.setAttribute("class","verticalNodes"+j),m.innerHTML="<td></td>",m.firstChild.appendChild(p),g.appendChild(m)):g.appendChild(p)):(p=document.createElement("tr"),p.setAttribute("class","nodes"+j),g.appendChild(n),g.appendChild(p)),h.forEach(function(a){var b;k?b=document.createElement("li"):(b=document.createElement("td"),b.setAttribute("colspan",2)),p.appendChild(b),e.buildHierarchy(b,a,c+1,d)}))},d.prototype._clickChart=function(a){var b=this._closest(a.target,function(a){return a.classList&&a.classList.contains("node")});!b&&this.chart.querySelector(".node.focused")&&this.chart.querySelector(".node.focused").classList.remove("focused")},d.prototype._clickExportButton=function(){var a=this.options,b=this.chartContainer,c=b.querySelector(".mask"),d=b.querySelector(".strutchart:not(.hidden)"),e="l2r"===a.direction||"r2l"===a.direction;c?c.classList.remove("hidden"):(c=document.createElement("div"),c.setAttribute("class","mask"),c.innerHTML='<i class="fa fa-circle-o-notch fa-spin spinner"></i>',b.appendChild(c)),b.classList.add("canvasContainer"),window.html2canvas(d,{width:e?d.clientHeight:d.clientWidth,height:e?d.clientWidth:d.clientHeight,onclone:function(a){var b=a.querySelector(".canvasContainer");b.style.overflow="visible",b.querySelector(".strutchart:not(.hidden)").transform=""}}).then(function(a){var c=b.querySelector(".oc-download-btn");b.querySelector(".mask").classList.add("hidden"),c.setAttribute("href",a.toDataURL()),c.click()}).catch(function(a){console.error("Failed to export the curent strutchart!",a)}).finally(function(){b.classList.remove("canvasContainer")})},d.prototype._loopChart=function(a){var b={id:a.querySelector(".node").id};return a.children[3]&&c(a.children[3].children).forEach(function(a){b.children||(b.children=[]),b.children.push(this._loopChart(a.firstChild))}),b},d.prototype.getHierarchy=function(){return this.chart.querySelector(".node").id?this._loopChart(this.chart.querySelector("table")):"Error: Nodes of orghcart to be exported must have id attribute!"},d.prototype._onPanStart=function(a){var c,d,e,f,g,h,b=a.currentTarget;if(this._closest(a.target,function(a){return a.classList&&a.classList.contains("node")})||a.touches&&a.touches.length>1)return b.dataset.panning=!1,void 0;if(b.style.cursor="move",b.dataset.panning=!0,c=0,d=0,e=window.getComputedStyle(b).transform,"none"!==e&&(f=e.split(","),e.includes("3d")?(c=Number.parseInt(f[12],10),d=Number.parseInt(f[13],10)):(c=Number.parseInt(f[4],10),d=Number.parseInt(f[5],10))),g=0,h=0,a.targetTouches){if(1===a.targetTouches.length)g=a.targetTouches[0].pageX-c,h=a.targetTouches[0].pageY-d;else if(a.targetTouches.length>1)return}else g=a.pageX-c,h=a.pageY-d;b.dataset.panStart=JSON.stringify({startX:g,startY:h}),b.addEventListener("mousemove",this._onPanning.bind(this)),b.addEventListener("touchmove",this._onPanning.bind(this))},d.prototype._onPanning=function(a){var c,d,e,f,g,h,i,b=a.currentTarget;if("false"!==b.dataset.panning){if(c=0,d=0,e=JSON.parse(b.dataset.panStart),f=e.startX,g=e.startY,a.targetTouches){if(1===a.targetTouches.length)c=a.targetTouches[0].pageX-f,d=a.targetTouches[0].pageY-g;else if(a.targetTouches.length>1)return}else c=a.pageX-f,d=a.pageY-g;h=window.getComputedStyle(b).transform,"none"===h?b.style.transform=h.includes("3d")?"matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+c+", "+d+", 0, 1)":"matrix(1, 0, 0, 1, "+c+", "+d+")":(i=h.split(","),h.includes("3d")?(i[12]=c,i[13]=d):(i[4]=c,i[5]=d+")"),b.style.transform=i.join(","))}},d.prototype._onPanEnd=function(){var b=this.chart;"true"===b.dataset.panning&&(b.dataset.panning=!1,b.style.cursor="default",document.body.removeEventListener("mousemove",this._onPanning),document.body.removeEventListener("touchmove",this._onPanning))},d.prototype._setChartScale=function(a,b){var d,c=window.getComputedStyle(a).transform;"none"===c?a.style.transform="scale("+b+","+b+")":(d=c.split(","),c.includes("3d")?a.style.transform=c+" scale3d("+b+","+b+", 1)":(d[0]="matrix("+b,d[3]=b,a.style.transform=c+" scale("+b+","+b+")")),a.dataset.scale=b},d.prototype._onWheeling=function(a){var b=a.deltaY>0?.8:1.2;this._setChartScale(this.chart,b),a.preventDefault()},d.prototype._getPinchDist=function(a){return Math.sqrt((a.touches[0].clientX-a.touches[1].clientX)*(a.touches[0].clientX-a.touches[1].clientX)+(a.touches[0].clientY-a.touches[1].clientY)*(a.touches[0].clientY-a.touches[1].clientY))},d.prototype._onTouchStart=function(a){var c,b=this.chart;a.touches&&2===a.touches.length&&(c=this._getPinchDist(a),b.dataset.pinching=!0,b.dataset.pinchDistStart=c)},d.prototype._onTouchMove=function(a){var c,b=this.chart;b.dataset.pinching&&(c=this._getPinchDist(a),b.dataset.pinchDistEnd=c)},d.prototype._onTouchEnd=function(){var c,b=this.chart;b.dataset.pinching&&(b.dataset.pinching=!1,c=b.dataset.pinchDistEnd-b.dataset.pinchDistStart,c>0?this._setChartScale(b,1):0>c&&this._setChartScale(b,-1))},d});